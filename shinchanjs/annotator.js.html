<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Annotator.js Demo">
    <meta name="author" content="Le Tuan Anh <tuananh.ke@gmail.com">
    <link rel="icon" href="../../favicon.ico">
    <!-- Title and styles -->
    <title>Annotator.js Demo</title>
    
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="modules/bootstrap-toggle/css/bootstrap-toggle.min.css" />
    <link rel="stylesheet" href="modules/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="modules/viz/demo.css" />
    <link rel="stylesheet" href="modules/viz/delphin-viz.css" />
    <link rel="stylesheet" href="modules/highlight.js/styles/github.css" />
    <!-- Demo CSS -->
    <link rel="stylesheet" href="css/visko2.css" />
    <!-- Annotator.js CSS -->
    <link rel="stylesheet" href="modules/annotator.js/annotator.min.css" />
    <style>
     #toolbar {
       /* T-R-B-L */
       margin: 5px 5px 5px 0px;
       padding: 4px;
       display: inline-block;
     }
     /* support: IE7 */
     *+html #toolbar {
       display: inline;
     }
    </style>
    
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="annotator.js.html">Annotator.js Demo</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="index.html">Home</a></li>
          </ul>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>
    
    <div style="padding: 60px 20px;">
      <div class="row">
        <div class="col-md-6">
	      <!-- Parsing Form -->
          <form style="padding: 20px 3px;">
            <div class="input-group input-group-lg">
              <span class="input-group-addon">Input</span>
              <input class="form-control input-lg" name="userinput" id="userinput" placeholder="Write anything here" value="Some dogs barked." type="text">
              <span class="input-group-btn">
                <button type="button" class="btn btn-default btn-lg" name="btnProcess" id="btnProcess" value="parse">Process</button>
              </span>
            </div>
	      </form>

          <h1>Annotator.js</h1>
          <div id="maintext">
            <p>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. 
            </p>
            <p>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. 
            </p>
          </div>
          
          <h1>window.selection()</h1>
          <div id="maintext2"><p>Lorem ipsum dolor sit amet, <b>consectetur</b> adipiscing elit, <i>sed do eiusmod tempor</i> incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p></div>
          
          <h1>textarea</h1>
          <textarea id="maintext3" style="width: 100%" rows="7" >Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
          </textarea>

          <h1>Canvas</h1>
          <div id="main_canvas"></div>
        </div>
        <div class="col-md-6">
          <!-- Control Panel and Console -->
          <div id="toolbar" class="input-group" style="padding: 10px 0px;">
	        <div class="input-group-btn">
              <input type="button" class="btn btn-primary" id="btnDebug" name="btnDebug" value="Debug"/>
              <button type="button" id="btnClear" name="btnClear" class="btn btn-default">Clear Console</button>
              <input type="checkbox" id="consoletoggle" checked data-toggle="toggle" data-on="Console" data-off="Console"></input>
	        </div>
          </div>
          <div id="console" style="overflow: auto; max-height: 80vh;"></div>
          <!-- End console UI -->
        </div>
      </div>
      
      <hr>
      
      <footer>
        <p>&copy; 2012-2017 Le Tuan Anh &lt;tuananh.ke@gmail.com&gt;</p>
      </footer>
    </div> <!-- /container -->
  </body>
  
  <!-- Bootstrap -->
  <script src="js/jquery-3.2.1.min.js"></script>
  <script src="modules/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="modules/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>
  <!-- Annotator.js -->
  <script src="modules/annotator.js/annotator-full.min.js"></script>
  <!-- Others -->
  <script src="js/lodash-4.17.4.min.js"></script>
  <!-- ShinchanJS scripts -->
  <script src="js/raphael-2.2.1.min.js"></script>
  <script src="js/console.js"></script>
  <script src="js/shinchan.js"></script>
  <script src="js/shinchan.debug.js"></script>
  <script src="js/visko-2.0.js"></script>
  <script src="js/powerranger.js"></script>
  
  <script>
   function debug(){
     console.writeline("Do this and that");
   }
   
   function process() {
     var input = $("#userinput").val();
     console.writeline("You wrote: " + input);
   }
  </script>
  
  <!-- Document ready -->
  <script>
   var canvas;
   var console;
   
   function initialise(){
     // Console support
     console = new Console("console", 220, ".:: Console Demo ::.<br/>");
     $("#btnClear").click(function() { console.clear(); });
     $(window).on('resize', function() { console.resize(); });
     $('#consoletoggle').change(function(){ console.toggle(); });
     console.clear().resize();
     
     // Init canvas
     canvas = new Canvas("main_canvas", 320, 240, "MainCanvas");
     
     // Bind events
     $("#btnDebug").click(debug);
     $("#btnProcess").click(process);

     // Load annotator
     $("#maintext").annotator();

     // using div selection
     $("#maintext2").mouseup(reportSelection);
     $("#maintext2").mousedown(reportSelection);
     $("#maintext2").select(reportSelection);
     $("#maintext2").keyup(reportSelection);

     // use textarea
     $("#maintext3").select(function(){
       if(this.textLength > 0){
         var _cfrom = this.selectionStart;
         var _cto = this.selectionEnd;
         var _text = this.value.substring(_cfrom, _cto);
         console.clear();
         console.writeline("Selected: " + _text + "&lt;:" + _cfrom + ":" + _cto + "&gt;");
       }
     });
   }

   // Adopted from:
   // https://stackoverflow.com/questions/4811822/get-a-ranges-start-and-end-offsets-relative-to-its-parent-container
   function getSelectionCharacterOffsetWithin(element) {
     var start = 0;
     var end = 0;
     var doc = element.ownerDocument || element.document;
     var win = doc.defaultView || doc.parentWindow;
     var sel;
     if (typeof win.getSelection != "undefined") {
       sel = win.getSelection();
       if (sel.rangeCount > 0) {
         var range = win.getSelection().getRangeAt(0);
         var preCaretRange = range.cloneRange();
         preCaretRange.selectNodeContents(element);
         preCaretRange.setEnd(range.startContainer, range.startOffset);
         start = preCaretRange.toString().length;
         preCaretRange.setEnd(range.endContainer, range.endOffset);
         end = preCaretRange.toString().length;
       }
     } else if ( (sel = doc.selection) && sel.type != "Control") {
       var textRange = sel.createRange();
       var preCaretTextRange = doc.body.createTextRange();
       preCaretTextRange.moveToElementText(element);
       preCaretTextRange.setEndPoint("EndToStart", textRange);
       start = preCaretTextRange.text.length;
       preCaretTextRange.setEndPoint("EndToEnd", textRange);
       end = preCaretTextRange.text.length;
     }
     return { start: start, end: end };
   }

   function reportSelection() {
     var selOffsets = getSelectionCharacterOffsetWithin( document.getElementById("maintext2") );
     msg = "Selection offsets: " + selOffsets.start + ", " + selOffsets.end;
     var _t = $("#maintext2").text();
     var selected = _t.substr(selOffsets.start, selOffsets.end);
     console.clear();
     console.writeline(msg);
     console.writeline("Selected: " + selected);
     console.writeline("All: " + _t);
   }
   
   $(document).ready(function(){       
     initialise();
   });
  </script>
</html>
