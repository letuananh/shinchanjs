<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
          "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="DMRS Visualisation - Version 0.3.1">
    <meta name="author" content="Le Tuan Anh <tuananh.ke@gmail.com">
    <link rel="icon" href="../../favicon.ico">
    <!-- Title and styles -->
    <title>VisualKopasu/DMRS Visualisation - Version 2.0</title>
    <!-- Bootstrap core CSS -->
    <link href="modules/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <!-- Visko -->
    <link rel="stylesheet" href="css/visko2.css" />
  </head>
  
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="visko-2.0-demo.html">VisualKopasu/DMRS Visualisation - Version 2.0</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="index.html">Home</a></li>
          </ul>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <div style="padding: 60px 20px;">
      <div class="row">
        <div class="col-md-6">
          <!-- DMRS column -->
          <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#dmrs">Visual DMRS</a></li>
            <li><a data-toggle="tab" href="#json">JSON</a></li>
          </ul>
          <div class="tab-content">
            <div id="dmrs" class="tab-pane fade in active">
              <!-- Parsing Form -->
              <form style="padding: 20px 3px;">
                <div class="input-group input-group-lg">
                  <input class="form-control input-lg" name="input_sentence" id="input_sentence" placeholder="Some dogs bark." value="Some dogs barked." type="text">
                  <span class="input-group-addon">Parse Count</span>
                  <select id="input_results" name="input_results" class="form-control input-small" title="Maximum parses">
                    <option value="1">1</option>
                    <option value="5" selected="">5</option>
                    <option value="10">10</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="500">500</option>
                  </select>
                  <span class="input-group-btn">
                    <button type="button" class="btn btn-default btn-lg" name="btnParse" id="btnParse" value="parse">Parse</button>
                  </span>
                </div>
              </form>
              <h2>DMRS</h2>
              <div id="dmrs1_canvas"></div>
              <div id="dmrs1_text_holder" class="dmrs_sentence_text"></div>
            </div>
            <div id="json" class="tab-pane fade">
              <pre><code id="dmrs1_json"></code></pre>
            </div>
          </div>
          <!-- Synset Information -->
          <div id="synsets"></div>
          <!-- End DMRS column -->
        </div>
        <div class="col-md-6">
          <!-- Control Panel and Console -->
          <div id="toolbar" class="input-group" style="padding: 10px 0px;">
            <input type="button" class="btn btn-primary" id="btnRenderDMRS" name="btnRenderDMRS" value="Render"/>
            <input type="button" class="btn btn-primary" id="btnClearCanvas" name="btnClearCanvas" value="Destroy"/>
            <input type="button" class="btn btn-default" id="btnDebug" name="btnDebug" value="Debug"/>
            <button type="button" id="btnClear" name="btnClear" class="btn btn-default">Clear Console</button>
            <button type="button" id="btnHide" name="btnHide" class="btn btn-default">Hide Console</button>
          </div>
          <div id="console" style="overflow: auto; max-height: 80vh;"></div>
        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; 2012-2017 Le Tuan Anh &lt;tuananh.ke@gmail.com&gt;</p>
      </footer>
    </div> <!-- /container -->
       
    <!-- Bootstrap -->
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="modules/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Others -->
    <script src="js/lodash-4.17.4.min.js"></script>
    <!-- ShinchanJS scripts -->
    <script src="js/raphael-2.2.1.min.js"></script>
    <script src="js/console.js"></script>
    <script src="js/shinchan.js"></script>
    <script src="js/shinchan.debug.js"></script>
    <script src="js/visko-2.0.js"></script>
    <!-- DMRS related scripts -->
    <script>
     var dmrs_canvas;
     
     function clearDMRS(){
       if (dmrs_canvas != undefined){
         dmrs_canvas.clear();
         dmrs_canvas = undefined;
         console.writeline("Canvas was destroyed");
       }
     }
     
     function showDMRS(){
       if (dmrs_canvas == undefined) {
         // Load DMRS JSON using AJAX
         json_url = "ajax/dmrs.json";
         console.writeline("Loading DMRS JSON from " + json_url);
         $.getJSON(json_url)
          .done(function(json) {
            render_json(json);
          })
          .fail(function( jqxhr, textStatus, error ) {
            var err = textStatus + ", " + error;
            console.writeline( "Request Failed: " + err );
          });
       }
     }

     function render_json(json){
       // Store JSON raw
       json_str = JSON.stringify(json);
       $('#dmrs1_json').text(json_str);
       console.writeline("JSON length: " + json_str.length + " characters");
       
       console.writeline("Creating DMRS Canvas");
       dmrs_canvas = json2canvas(json, "dmrs1", find_synset);
       // Now render
       console.writeline("Rendering DMRS");
       dmrs_canvas.visualise();
       console.writeline("Done!");
     }

     /** Sample synset link builder **/
     function find_synset(synsetid) {
       return function(){ 
         get_yawol().load_synset(synsetid);
       };
     }

     function draw_dmrs(){
       showDMRS();
       show_info();
     }

     /** Show debug info **/
     function show_info() {
       if (dmrs_canvas == undefined) {
         return;
       }
       // Inspect DMRS
       var dmrs = dmrs_canvas.get_data();
       console.writeline("Text           : " + dmrs.text);       
       console.writeline("Visko Node data: " + dmrs.nodes);
       // Test get node by ID => get visual element => bind an event
       var n = dmrs.node_map['10001'];
       console.write(" | Visual elem: " + n.visual_element);
       n.visual_element.click(function(){console.writeline('I am fabulous!')});
       console.writeline("Find this and click it >>> " + n.nodeid + '/' + n.text);
     }

     /** Parse a sentence using RESTful **/
     function do_parse() {
       var results = $('#input_results').val();
       var sent = $('#input_sentence').val();
       var grm_url = 'http://chimpanzee.ling.washington.edu/bottlenose/erg/parse';
       console.writeline("Parsing sentence: " + sent);
       console.writeline("Grammar URL     : " + grm_url);
       // This script was adopted from: https://github.com/delph-in/delphin-viz
       $.ajax({
         url: grm_url,
         dataType: 'json',
         data: {
           'derivation': 'null', 
           'mrs': 'null',
           'dmrs': 'json',
           'input': sent,
           'results': results
         },
         dataFilter: function(data) {
           // Fix buggy JSON from LKB server
           return data.replace(/([^,]) "pedges"/, '$1, "pedges"');
         },
         success: function(json){
           delphin_json = json;
           if (json.results.length > 0) {
             // render
             clearDMRS();
             j = json.results[0].dmrs;
             j['text'] = json.input;
             render_json(j);
           }
         },
         error: function(data){
           console.writeline("Error");
         }
       });
     }          
        </script>
    <!-- Yawol client -->
    <script src="js/yawol.js"></script>
    <!-- Yawol support -->
    <script type="text/template" id="synsetbox_template">
     <div class="synsetbox container-fluid well">
     <div class="row">
     <div class="col-xs-12">
      <button type="button" class="close" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
     </div>
     </div>
     <div class="row">
     <div class="col-xs-12 col-sm-2 col-md-2">
      <label>SynsetID</label>
     </div>
     <div class="col-xs-12 col-sm-2 col-md-2">
      <span class="synsetid"><%= synset.synsetid %></span>                
     </div>
     <div class="col-xs-12 col-sm-2 col-md-2">
      <label>Lemmas</label> <span class="lemma"></span>
     </div>
     <div class="col-xs-12 col-sm-6 col-md-6">
      <span class="lemmas"><%= _.join(synset.lemmas, ', ') %></span>
     </div>
     </div>
     <div class="row">
     <div class="col-xs-12 col-md-2">
      <label>Definition</label>
     </div>
     <div class="col-xs-12 col-md-10">
      <span class="definition"><%= synset.definition %></span>
     </div>
     </div>
     <div class="row">
     <div class="col-xs-12 col-md-2">
      <label>Examples</label>
     </div>
     <div class="col-xs-12 col-md-10">
       <span class="examples">
         <% if(synset.examples.length > 0) {  %>
         <ul>
           <% _.each(synset.examples, function(ex){ %>
           <li><%= ex %></li>
           <% }); %>
         </ul>
         <% } %>    
       </span>
     </div>
     </div>
     </div>
    </script>
    <script>
     var yawol;

     function get_yawol() {
       var yawol = undefined;
       if (yawol == undefined) {
         // var root = $('#yawol_url').val();
         // console.writeline("Yawol root: " + root);
         var root = undefined;
         yawol = new Yawol("synsets", root, $("#synsetbox_template").html());
       }
       return yawol;
     }
    </script>
    <!-- Document ready -->
    <script>
     $(document).ready(function(){       
       initialise();   
       draw_dmrs();
     });

     function initialise(){
       // Console support
       console = new Console("console");
       $("#btnClear").click(clear_console);
       $("#btnHide").click(toggleConsole);
       clear_console();
       update_console();
       $('#synset_info').hide();
       
       $("#btnDebug").click(function(){
         clear_console();
         show_info();
         // Dump canvas structure to console
         console.header("DMRS Canvas structure");
         displayInformation(dmrs_canvas.get_canvas());
       });
       $("#btnClearCanvas").click(function(){
         clearDMRS();
       });
       $("#btnRenderDMRS").click(function(){
         clearDMRS(); // Don't display it twice
         showDMRS();
       });
       $("#btnParse").click(function(){
         do_parse();
       });
       $("#btnHideSynset").click(function(){ $('#synset_info').hide(); });
     }     
    </script>
    <!-- Console support -->
    <script>
     var console;

     $(window).on('resize', function(){
       update_console();
     });

     function toggleConsole(){
       $("#console").toggle();
       if($("#console").is(":visible")){
         $("#btnHide").text("Hide Console");                
       } 
       else{
         $("#btnHide").text("Show Console");
       }
     }
     
     function update_console(){
       var ch = $(window).height() - 130;
       if (ch < 300){
         ch = 300;
       }
       $("#console").height(ch);
       $("#console").css('max-height', ch);
       //console.writeline("Window's height: " + $(window).height());
     }

     function clear_console() {
       console.clear("VisualKopasu/DMRS Visualisation - Version 2.0");
       console.writeline();
     }
    </script>
  </body>
</html>
